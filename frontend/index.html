<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Add a line to a map using a GeoJSON source</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js"></script>
<script src="//code.jquery.com/jquery-1.12.1.min.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div>
	Hello!
	Upload GPX file:
</div>
<div id="map"></div>
<script>



// mapbox seems to suck cock, i want to rewrite this in leaflet

mapboxgl.accessToken = 'xxxx';

// init geojson files
const map = new mapboxgl.Map({
	container: 'map',
	style: 'mapbox://styles/mapbox/streets-v11',
	center: [139.29082967994404, 35.47802228742353],
	zoom: 10
});

// url is made using a polyline

map.on('load', () => {
	console.log('loaded map')
	fetch(url).then(response => response.json()).then(metadata => {
		console.log(metadata);
		Promise.all(
		    metadata.map(img => new Promise((resolve, reject) => {
			map.loadImage(img.icon, function (error, res) {
			    map.addImage(img.name, res)
			    console.log('img added')
			    resolve();
			})
		    }))
		).then(() => {
			console.log('loaded images')
			metadata.map(poi => {
				console.log(poi)
				map.addSource(poi.name, {
					'type': 'geojson',
					'data': poi.source,
					'generateId': true
				});
				map.addLayer({
					'id': poi.series,
					'type': 'symbol',
					'source': poi.name,
					'layout': {
						'icon-image': poi.name,
						'icon-size': 0.1,
						'icon-allow-overlap': true,
						'icon-ignore-placement': true,   
					},
				});
				map.on('mouseenter', poi.series, (e) => {
					// Change the cursor style as a UI indicator.
					map.getCanvas().style.cursor = 'pointer';

					// Copy coordinates array.
					const coordinates = e.features[0].geometry.coordinates.slice();
					const description = poi.name + '<br>' + e.features[0].properties.name;

					// Ensure that if the map is zoomed out such that multiple
					// copies of the feature are visible, the popup appears
					// over the copy being pointed to.
					while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
						coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
					}

					// Populate the popup and set its coordinates
					// based on the feature found.
					popup.setLngLat(coordinates).setHTML(description).addTo(map);
				});

				map.on('mouseleave', poi.series, () => {
					map.getCanvas().style.cursor = '';
					popup.remove();
				});
			})
		});

		map.addSource('route', {
			'type': 'geojson',
			'data': 'route.geojson',
			'generateId': true
		});
		map.addLayer({
			'id': 'route',
			'type': 'line',
			'source': 'route',
			'layout': {
				'line-join': 'round',
				'line-cap': 'round'
			},
			'paint': {
				'line-color': '#FF5F1F',
				'line-width': 8
			}
		});

		const popup = new mapboxgl.Popup({
			closeButton: false,
			closeOnClick: false
		});

	});
});


</script>

</body>
</html>
